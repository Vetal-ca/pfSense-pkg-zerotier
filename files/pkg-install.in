#!/bin/sh

# Ensure environment variables are set
: ${STAGEDIR:?"STAGEDIR is not set"}
: ${PREFIX:?"PREFIX is not set"}
: ${FILESDIR:?"FILESDIR is not set"}
: ${DATADIR:?"DATADIR is not set"}
: ${REINPLACE_CMD:?"REINPLACE_CMD is not set"}
: ${PKGVERSION:?"PKGVERSION is not set"}

echo "Stagedir: ${STAGEDIR}"
echo "Prefix: ${PREFIX}"
echo "Filedir: ${FILESDIR}"
echo "Datadir: ${DATADIR}"

# Download and install ZeroTier package
fetch -o /tmp/zerotier.pkg https://github.com/${GITHUB_OWNER}/${GITHUB_REPO}/releases/download/zerotier-${ZEROTIER_VERSION}/zerotier-${ZEROTIER_VERSION}.pkg
pkg add /tmp/zerotier.pkg

# Create necessary directories
mkdir -p ${STAGEDIR}${PREFIX}/pkg
mkdir -p ${STAGEDIR}${PREFIX}/www
mkdir -p ${STAGEDIR}${DATADIR}


# Install files
install -m 644 ${FILESDIR}${PREFIX}/pkg/zerotier.xml ${STAGEDIR}${PREFIX}/pkg
install -m 644 ${FILESDIR}${PREFIX}/pkg/zerotier.inc ${STAGEDIR}${PREFIX}/pkg
install -m 644 ${FILESDIR}${DATADIR}/info.xml ${STAGEDIR}${DATADIR}
install -m 644 ${FILESDIR}${PREFIX}/www/zerotier.php ${STAGEDIR}${PREFIX}/www
install -m 644 ${FILESDIR}${PREFIX}/www/zerotier_networks.php ${STAGEDIR}${PREFIX}/www
install -m 644 ${FILESDIR}${PREFIX}/www/zerotier_peers.php ${STAGEDIR}${PREFIX}/www
install -m 644 ${FILESDIR}${PREFIX}/www/zerotier_controller.php ${STAGEDIR}${PREFIX}/www
install -m 644 ${FILESDIR}${PREFIX}/www/zerotier_controller_network.php ${STAGEDIR}${PREFIX}/www

# Replace placeholders in info.xml
${REINPLACE_CMD} -i '' -e "s|%%PKGVERSION%%|${PKGVERSION}|" ${STAGEDIR}${DATADIR}/info.xml

if [ "${2}" != "POST-INSTALL" ]; then
	exit 0
fi

/usr/local/bin/php -f /etc/rc.packages %%PORTNAME%% ${2}
